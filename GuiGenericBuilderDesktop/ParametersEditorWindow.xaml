<Window x:Class="GuiGenericBuilderDesktop.ParametersEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:GuiGenericBuilderDesktop"
        Title="Edit Parameters" 
        Height="450" 
        Width="700"
        WindowStartupLocation="CenterOwner"
        Background="#F5F5F5">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:EnumValueToNameConverter x:Key="EnumValueToNameConverter"/>
    </Window.Resources>
    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock x:Name="FlagTitle" FontWeight="Bold" FontSize="14" Margin="0,0,0,8"/>

        <DataGrid x:Name="ParamsGrid" Grid.Row="1" AutoGenerateColumns="False" CanUserAddRows="False" ItemsSource="{Binding}" RowEditEnding="ParamsGrid_RowEditEnding">

            <DataGrid.Resources>
                <DataTemplate x:Key="TextTemplate">
                    <TextBox Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                </DataTemplate>

                <DataTemplate x:Key="NumberTemplate">
                    <TextBox Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" PreviewTextInput="NumberOnly_PreviewTextInput" />
                </DataTemplate>
                
                <DataTemplate x:Key="EnumTemplate">
                    <ComboBox ItemsSource="{Binding EnumValues}" 
                              SelectedValue="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                              SelectedValuePath="Value"
                              MinWidth="200"
                              IsDropDownOpen="True">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock>
                                    <Run Text="{Binding Name, Mode=OneWay}" FontWeight="SemiBold"/>
                                    <Run Text=" - " Foreground="Gray"/>
                                    <Run Text="{Binding Description, Mode=OneWay}" Foreground="Gray"/>
                                </TextBlock>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </DataTemplate>

                <local:ValueEditorTemplateSelector x:Key="ValueEditorSelector"
                                                   TextTemplate="{StaticResource TextTemplate}"
                                                   NumberTemplate="{StaticResource NumberTemplate}"
                                                   EnumTemplate="{StaticResource EnumTemplate}"/>

            </DataGrid.Resources>

            <DataGrid.Columns>
                <!-- Name column: read-only display with required indicator -->
                <DataGridTemplateColumn Header="Name" Width="2*" IsReadOnly="True">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                <TextBlock Text=" *" Foreground="Red" FontWeight="Bold" 
                                          Visibility="{Binding IsRequired, Converter={StaticResource BooleanToVisibilityConverter}}"
                                          ToolTip="This parameter is required"/>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <!-- Value column: editing control type depends on Type -->
                <DataGridTemplateColumn Header="Value" Width="3*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock VerticalAlignment="Center">
                                <TextBlock.Text>
                                    <MultiBinding Converter="{StaticResource EnumValueToNameConverter}">
                                        <Binding Path="Value"/>
                                        <Binding Path="."/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <ContentControl Content="{Binding}" ContentTemplateSelector="{StaticResource ValueEditorSelector}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

            </DataGrid.Columns>

        </DataGrid>

        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
            <Button Content="OK" Width="80" Margin="4" Click="Ok_Click" />
            <Button Content="Cancel" Width="80" Margin="4" Click="Cancel_Click" />
        </StackPanel>
    </Grid>
</Window>
